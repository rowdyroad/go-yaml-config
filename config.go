package config

import (
	"flag"
	"os"
	"path/filepath"
	"strings"
	"syscall"

	"github.com/go-yaml/yaml"
	"github.com/jinzhu/copier"
	log "github.com/rowdyroad/go-simple-logger"
)

// LoadConfigFromFile loading config from yaml file
func LoadConfigFromFile(config interface{}, configFile string, defaultValue interface{}) string {
	log.Debugf("Reading configuration from '%s'", configFile)

	data, err := os.ReadFile(configFile)
	if err != nil {
		log.Warn("Configuration not found")
		if defaultValue != nil {
			log.Warn("Default value is defined. Using it.")
			copier.Copy(config, defaultValue)
			return ""
		}
		panic(err)
	}

	if err := yaml.Unmarshal([]byte(os.Expand(string(data), getEnvWithDefault)), config); err != nil {
		log.Warn("Configuration incorrect ")
		if defaultValue != nil {
			log.Warn("Default value is defined. Use it.")
			copier.Copy(config, defaultValue)
			return ""
		}
		panic(err)
	}

	customConfigFile := filepath.Join(
		filepath.Dir(configFile),
		strings.TrimSuffix(filepath.Base(configFile), filepath.Ext(configFile))+".custom"+filepath.Ext(configFile),
	)
	log.Debugf("Try to read custom configuration from '%s'...", customConfigFile)
	data, err = os.ReadFile(customConfigFile)
	if err == nil {
		log.Debugf("Reading custom configuration from '%s'", customConfigFile)
		if err := yaml.Unmarshal([]byte(os.Expand(string(data), getEnvWithDefault)), config); err != nil {
			panic(err)
		}
		log.Debug("Config loaded successfully with custom config file")
		return customConfigFile
	}

	log.Debug("Config loaded successfully")
	return configFile
}

// LoadConfig from command line argument
func LoadConfig(config interface{}, defaultFilename string, defaultValue interface{}) string {
	var configFile string
	flag.StringVar(&configFile, "c", defaultFilename, "Config file")
	flag.StringVar(&configFile, "config", defaultFilename, "Config file")
	flag.Parse()
	return LoadConfigFromFile(config, configFile, defaultValue)
}

func getEnvWithDefault(key string) string {
	defaultVal := ""
	if idx := strings.Index(key, "="); idx != -1 {
		defaultVal = key[idx+1:]
		key = key[:idx]
	}
	v, has := syscall.Getenv(key)
	if !has {
		v = defaultVal
	}
	v = strings.Trim(v, " \n")
	if strings.Contains(v, "\n") {
		v = `"` + strings.ReplaceAll(v, "\n", "\\n") + `"`
	}
	return v
}
